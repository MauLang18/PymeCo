@* Views/Product/EditProduct.cshtml *@
@model POS.Application.DTOs.ProductDto

@{
    ViewBag.Title = "Edit Product";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int productId = 0;
    if (ViewBag.ProductId is int vbId) productId = vbId;

    if (productId == 0)
    {
        var routeIdObj = ViewContext.RouteData.Values["id"];
        if (routeIdObj != null && int.TryParse(routeIdObj.ToString(), out var rid))
            productId = rid;
    }
}

<div class="max-w-2xl mx-auto bg-[color:var(--light-panel)] border border-[color:var(--border)] rounded-2xl shadow-sm p-8 mt-10">
    <h1 class="text-2xl font-bold text-[color:var(--txt-primary)] mb-6 flex items-center gap-2">
        <i data-lucide="edit-2" class="w-6 h-6 text-[color:var(--primary)]"></i>
        Edit Product
    </h1>

    <form asp-action="EditProduct"
          asp-controller="Product"
          asp-route-id="@productId"
          method="post"
          class="space-y-6"
          enctype="multipart/form-data">
        <!-- necesario para subir archivo -->
        @Html.AntiForgeryToken()

        @* Redundancia intencional: además de ir en la URL, envío el id en el body *@
        <input type="hidden" name="id" value="@productId" />

        <div asp-validation-summary="ModelOnly" class="text-[color:var(--error)] text-sm"></div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
                <label asp-for="Name" class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2"></label>
                <input asp-for="Name" maxlength="200" placeholder="Product name"
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[color:var(--primary)]" />
                <span asp-validation-for="Name" class="text-[color:var(--error)] text-sm"></span>
            </div>

            <div>
                <label asp-for="CategoryId" class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2"></label>
                <input asp-for="CategoryId" type="number" min="1" placeholder="Category Id"
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[color:var(--primary)]" />
                <span asp-validation-for="CategoryId" class="text-[color:var(--error)] text-sm"></span>
            </div>

            <div>
                <label asp-for="Price" class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2"></label>
                <input asp-for="Price" type="number" step="0.01" min="0" placeholder="0.00"
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[color:var(--primary)]" />
                <span asp-validation-for="Price" class="text-[color:var(--error)] text-sm"></span>
            </div>

            <div>
                <label asp-for="TaxPercent" class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2"></label>
                <input asp-for="TaxPercent" type="number" step="0.01" min="0" max="100" placeholder="%"
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[color:var(--primary)]" />
                <span asp-validation-for="TaxPercent" class="text-[color:var(--error)] text-sm"></span>
            </div>

            <div>
                <label asp-for="Stock" class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2"></label>
                <input asp-for="Stock" type="number" min="0" placeholder="Available quantity"
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[color:var(--primary)]" />
                <span asp-validation-for="Stock" class="text-[color:var(--error)] text-sm"></span>
            </div>

            <div class="sm:col-span-2">
                @* Mostrar la URL actual sin ligarla para evitar validación de navegador *@
                <label class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2">Current image URL</label>
                <input value="@Model.ImageUrl" readonly
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 bg-[color:var(--light-bg)] text-[color:var(--txt-secondary)]" />

                @if (!string.IsNullOrWhiteSpace(Model.ImageUrl))
                {
                    <div class="mt-3">
                        <img src="@Model.ImageUrl" alt="@Model.Name" class="w-20 h-20 rounded-lg object-cover border border-[color:var(--border)]" />
                    </div>
                }
            </div>

            <div class="sm:col-span-2">
                <label asp-for="ImageFile" class="block text-sm font-medium text-[color:var(--txt-secondary)] mb-2"></label>
                <input asp-for="ImageFile" type="file" accept="image/*"
                       class="w-full border border-[color:var(--border)] rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-[color:var(--primary)]" />
                <span asp-validation-for="ImageFile" class="text-[color:var(--error)] text-sm"></span>

                @* Mantener/transportar ImageUrl si no adjuntan nuevo archivo *@
                <input asp-for="ImageUrl" type="hidden" />
            </div>

            <div class="sm:col-span-2">
                <label class="inline-flex items-center gap-2">
                    <input asp-for="Active" class="h-4 w-4" />
                    <span>Active</span>
                </label>
                <span asp-validation-for="Active" class="text-[color:var(--error)] text-sm"></span>
            </div>
        </div>

        <div class="mt-8 flex justify-end gap-4">
            <a asp-controller="Product" asp-action="ListProduct"
               class="px-5 py-2.5 border border-[color:var(--border)] text-[color:var(--txt-secondary)] rounded-xl hover:bg-[color:var(--light-bg)] transition-colors">
                Cancel
            </a>
            <button type="submit"
                    class="px-5 py-2.5 bg-[color:var(--primary)] text-white font-medium rounded-xl hover:bg-[color:var(--primary-dark)] transition-colors flex items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i> Save changes
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
