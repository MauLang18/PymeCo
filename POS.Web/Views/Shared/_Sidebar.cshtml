@using Microsoft.AspNetCore.Identity
@using POS.Domain.Entities

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@functions {
    string Active(string controller, string action)
    {
        var c = (ViewContext.RouteData.Values["controller"] as string) ?? "";
        var a = (ViewContext.RouteData.Values["action"] as string) ?? "";
        return (c.Equals(controller, StringComparison.OrdinalIgnoreCase)
             && a.Equals(action, StringComparison.OrdinalIgnoreCase))
            ? "bg-blue-50 text-[color:var(--primary)]"
            : "text-gray-500";
    }
}

<aside class="w-64 h-screen bg-white border-r border-gray-200 flex flex-col justify-between">
    <div>
        <!-- Menú principal -->
        <nav class="flex flex-col gap-2 mt-4 px-4 text-gray-700">
            @if (SignInManager.IsSignedIn(User))
            {
                var currentUser = await UserManager.GetUserAsync(User);
                var userRoles = await UserManager.GetRolesAsync(currentUser!);
                var mainRole = userRoles.FirstOrDefault() ?? "Usuario";

                <!-- Dashboard (Admin y Vendedor) -->
                @if (mainRole == "Admin" || mainRole == "Vendedor")
                {
                    <a href="@Url.Action("Index", "Home")"
                       class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-[color:var(--primary)] transition-colors @Active("Home", "Index")">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </a>
                }

                <!-- Productos (TODOS) -->
                <a href="@Url.Action("ListProduct", "Product")"
                   class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-[color:var(--primary)] transition-colors @Active("Product", "ListProduct")">
                    <i data-lucide="package" class="w-5 h-5"></i>
                    <span>Productos</span>
                </a>

                <!-- Pedidos (Admin y Cajero) -->
                @if (mainRole == "Admin" || mainRole == "Cajero")
                {
                    <a href="@Url.Action("Index", "Pedido")"
                       class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-[color:var(--primary)] transition-colors @Active("Pedido", "Index")">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span>Pedidos</span>
                    </a>
                }

                <!-- Clientes (Admin y Vendedor) -->
                @if (mainRole == "Admin" || mainRole == "Vendedor")
                {
                    <a href="@Url.Action("ListClient", "Client")"
                       class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-[color:var(--primary)] transition-colors @Active("Client", "ListClient")">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Clientes</span>
                    </a>
                }



                <!-- Gestión de Usuarios (Solo Admin) -->
                @if (mainRole == "Admin")
                {
                    <a href="@Url.Action("Index", "UserManagement")"
                       class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 hover:text-[color:var(--primary)] transition-colors @Active("UserManagement", "Index")">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Usuarios</span>
                    </a>
                }
                <hr class="my-4 border-gray-200" />

            }
            else
            {
                <!-- Usuario NO autenticado -->
                <p class="text-gray-400 text-sm px-3">Inicie sesión para acceder al panel</p>
            }
        </nav>
    </div>

    <!-- Botón de Cerrar Sesión (parte inferior) -->
    @if (SignInManager.IsSignedIn(User))
    {
        <div class="px-4 pb-4">
            <form asp-controller="Auth" asp-action="Logout" method="post" class="w-full">
                @Html.AntiForgeryToken()
                <button type="submit"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Cerrar Sesión
                </button>
            </form>
        </div>
    }
    else
    {
        <!-- Botones de Login/Signup si NO está autenticado -->
        <div class="px-4 pb-4 flex flex-col gap-3">
            <a href="@Url.Action("Signup", "Auth")"
               class="bg-[color:var(--primary)] text-white text-center px-4 py-2 rounded-lg hover:bg-[color:var(--primary-dark)] transition-colors">
                Sign Up
            </a>
            <a href="@Url.Action("Login", "Auth")"
               class="bg-white border border-[color:var(--primary)] text-[color:var(--primary)] text-center px-4 py-2 rounded-lg hover:bg-blue-50 transition-colors">
                Log In
            </a>
        </div>
    }
</aside>

@section Scripts {
    <script>
        if (window.lucide?.createIcons) window.lucide.createIcons();
    </script>
}
