@model POS.Application.DTOs.PedidoDto
@using POS.Domain.Entities

@{
    ViewData["Title"] = "Nuevo Pedido";
    var productosData = ViewBag.ProductosData as IEnumerable<Product>;
    var usuarioNombre = ViewBag.UsuarioNombre as string ?? "Usuario";
}

<div class="max-w-7xl mx-auto space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl font-semibold text-gray-900">Nuevo Pedido</h1>
            <p class="text-sm text-gray-500">Crea un pedido seleccionando cliente y agregando productos.</p>
        </div>
        <a asp-action="Index"
           class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-gray-700 hover:bg-gray-100">
            Volver
        </a>
    </div>

    <form asp-action="CreatePedido" method="post" id="formPedido" class="space-y-6">
        @Html.AntiForgeryToken()

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Datos -->
            <div class="rounded-xl border border-gray-200 bg-white p-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Datos</h3>
                <div class="space-y-4">
                    <div>
                        <label asp-for="ClienteId" class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                        <select asp-for="ClienteId"
                                asp-items="ViewBag.Clientes"
                                class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                required>
                        </select>
                        <span asp-validation-for="ClienteId" class="text-red-600 text-sm"></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                        <input value="@usuarioNombre"
                               class="w-full rounded-lg border-gray-200 bg-gray-50 text-gray-600"
                               disabled />
                        <input type="hidden" asp-for="UsuarioId" />
                    </div>
                    <div>
                        <label asp-for="EstadoPedido" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <select asp-for="EstadoPedido"
                                class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                            <option value="Enviado">Enviado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="rounded-xl border border-gray-200 bg-white p-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Totales</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Subtotal</label>
                        <input id="Subtotal"
                               class="w-full rounded-lg border-gray-300 text-right font-medium"
                               readonly disabled />
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Impuestos</label>
                        <input id="Impuestos"
                               class="w-full rounded-lg border-gray-300 text-right font-medium"
                               readonly disabled />
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Total</label>
                        <input id="Total"
                               class="w-full rounded-lg border-gray-300 text-right font-bold"
                               readonly disabled />
                    </div>
                </div>

                <!-- Hidden para mandar al DTO -->
                <input type="hidden" asp-for="Subtotal" id="SubtotalHidden" />
                <input type="hidden" asp-for="Impuestos" id="ImpuestosHidden" />
                <input type="hidden" asp-for="Total" id="TotalHidden" />
            </div>
        </div>

        <!-- Detalles -->
        <div class="rounded-xl border border-gray-200 bg-white">
            <div class="flex items-center justify-between p-4">
                <h3 class="text-sm font-semibold text-gray-700">Detalles</h3>
                <button type="button"
                        id="btnOpenModal"
                        class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-2 text-white hover:bg-blue-700">
                    <i data-lucide="plus" class="w-4 h-4"></i> Agregar producto
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 text-left text-gray-600">
                        <tr>
                            <th class="px-4 py-3 font-medium">Producto</th>
                            <th class="px-4 py-3 font-medium text-right">Cant.</th>
                            <th class="px-4 py-3 font-medium text-right">Precio</th>
                            <th class="px-4 py-3 font-medium text-right">Imp. %</th>
                            <th class="px-4 py-3 font-medium text-right">Total línea</th>
                            <th class="px-4 py-3 font-medium text-right"></th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDetalles" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="flex justify-end gap-3">
            <button type="submit"
                    class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">
                <i data-lucide="check" class="w-4 h-4"></i> Guardar
            </button>
            <a asp-action="Index"
               class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50">
                Cancelar
            </a>
        </div>
    </form>
</div>

<!-- Modal -->
<div id="modalDetalle" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/30">
    <div class="w-full max-w-2xl rounded-xl bg-white p-5 shadow-xl">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold text-gray-900">Agregar producto</h3>
            <button type="button"
                    class="text-gray-500 hover:text-gray-700"
                    id="btnCloseModal">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
                <select id="mdlProductoId"
                        class="w-full rounded-lg border-gray-300">
                    <option value="">Seleccione un producto</option>
                    @if (productosData != null && productosData.Any())
                    {
                        foreach (var p in productosData)
                        {
                            <option value="@p.Id"
                                    data-precio="@p.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                    data-imp="@p.TaxPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                    data-stock="@p.Stock">
                                @p.Name (Stock: @p.Stock)
                            </option>
                        }
                    }
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                <input id="mdlCantidad"
                       type="number"
                       min="1"
                       max="999999"
                       value="1"
                       class="w-full rounded-lg border-gray-300 text-right" />
                <small id="stockWarning" class="text-red-600 hidden">Stock insuficiente</small>
            </div>
        </div>

        <div class="mt-4 flex items-center justify-between">
            <small class="text-gray-500">
                Precio e impuestos se cargan automáticamente desde el producto.
            </small>
            <div class="flex gap-2">
                <button type="button"
                        class="rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                        id="btnCloseModal2">
                    Cerrar
                </button>
                <button type="button"
                        class="rounded-lg bg-blue-600 px-3 py-2 text-white hover:bg-blue-700"
                        id="btnAddLinea">
                    Agregar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const modal = document.getElementById('modalDetalle');
        const openModal = () => modal.classList.remove('hidden');
        const closeModal = () => modal.classList.add('hidden');

        document.getElementById('btnOpenModal').addEventListener('click', openModal);
        document.getElementById('btnCloseModal').addEventListener('click', closeModal);
        document.getElementById('btnCloseModal2').addEventListener('click', closeModal);

        const tbody = document.getElementById('tbodyDetalles');
        const fmt = n => (Number(n) || 0).toFixed(2);

        // Validar stock cuando cambia el producto o la cantidad
        const mdlProductoId = document.getElementById('mdlProductoId');
        const mdlCantidad = document.getElementById('mdlCantidad');
        const stockWarning = document.getElementById('stockWarning');
        const btnAddLinea = document.getElementById('btnAddLinea');

        function validateStock() {
            const sel = mdlProductoId;
            const opt = sel.options[sel.selectedIndex];
            const stock = +(opt?.dataset?.stock || 0);
            const cant = +mdlCantidad.value || 0;

            if (opt && opt.value && cant > stock) {
                stockWarning.classList.remove('hidden');
                stockWarning.textContent = `Stock disponible: ${stock}`;
                btnAddLinea.disabled = true;
                btnAddLinea.classList.add('opacity-50', 'cursor-not-allowed');
                mdlCantidad.max = stock;
                return false;
            } else {
                stockWarning.classList.add('hidden');
                btnAddLinea.disabled = false;
                btnAddLinea.classList.remove('opacity-50', 'cursor-not-allowed');
                if (opt && opt.value) {
                    mdlCantidad.max = stock;
                }
                return true;
            }
        }

        mdlProductoId.addEventListener('change', validateStock);
        mdlCantidad.addEventListener('input', validateStock);

        function recalcResumen() {
            let subtotal = 0, impuestos = 0, total = 0;
            tbody.querySelectorAll('tr').forEach(tr => {
                const tl = +tr.dataset.totalLinea || 0;
                const im = +tr.dataset.impMonto || 0;
                subtotal += (tl - im);
                impuestos += im;
                total += tl;
            });

            document.getElementById('Subtotal').value = fmt(subtotal);
            document.getElementById('Impuestos').value = fmt(impuestos);
            document.getElementById('Total').value = fmt(total);

            document.getElementById('SubtotalHidden').value = subtotal;
            document.getElementById('ImpuestosHidden').value = impuestos;
            document.getElementById('TotalHidden').value = total;
        }

        function addLinea(prodId, prodText, cant, precio, impPercent) {
            const bruto = cant * precio;
            const impMonto = bruto * (impPercent / 100);
            const totalLinea = bruto + impMonto;

            const idx = tbody.querySelectorAll('tr').length;
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.dataset.totalLinea = totalLinea;
            tr.dataset.impMonto = impMonto;
            tr.dataset.precio = precio;
            tr.dataset.imp = impPercent;

            tr.innerHTML = `
                <td class="px-4 py-3">
                    <input type="hidden" name="Detalles[${idx}].ProductoId" value="${prodId}" />
                    <span>${prodText} (${prodId})</span>
                </td>
                <td class="px-4 py-3 text-right">
                    <input class="w-24 rounded-md border border-gray-300 text-right"
                           type="number" min="1"
                           name="Detalles[${idx}].Cantidad"
                           value="${cant}" />
                </td>
                <td class="px-4 py-3 text-right">
                    <span>${fmt(precio)}</span>
                    <input type="hidden"
                           name="Detalles[${idx}].PrecioUnitario"
                           value="${precio}" />
                </td>
                <td class="px-4 py-3 text-right">
                    <span>${fmt(impPercent)}</span>
                    <input type="hidden"
                           name="Detalles[${idx}].ImpuestoPorc"
                           value="${impPercent}" />
                </td>
                <td class="px-4 py-3 text-right font-semibold">
                    <span class="js-total-linea">${fmt(totalLinea)}</span>
                    <input type="hidden"
                           name="Detalles[${idx}].TotalLinea"
                           value="${totalLinea}" />
                    <input type="hidden"
                           name="Detalles[${idx}].DescuentoPorc"
                           value="0" />
                </td>
                <td class="px-4 py-3 text-right">
                    <button type="button"
                            class="inline-flex items-center rounded-lg border border-red-300 px-2 py-1 text-red-600 hover:bg-red-50 js-del">
                        Eliminar
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            recalcResumen();
        }

        btnAddLinea.addEventListener('click', () => {
            const sel = mdlProductoId;
            const pid = sel.value;
            const opt = sel.options[sel.selectedIndex];

            if (!pid || !opt) return;

            const ptxt = opt.text;
            const precio = +opt.dataset.precio || 0;
            const impPercent = +opt.dataset.imp || 0;
            const cant = +mdlCantidad.value || 0;

            if (!pid || cant <= 0) return;

            // Validar stock antes de agregar
            if (!validateStock()) {
                alert('La cantidad solicitada supera el stock disponible.');
                return;
            }

            addLinea(pid, ptxt, cant, precio, impPercent);

            // reset modal
            mdlCantidad.value = 1;
            sel.value = "";
            stockWarning.classList.add('hidden');
            closeModal();
        });

        tbody.addEventListener('click', e => {
            if (e.target.closest('.js-del')) {
                e.target.closest('tr').remove();

                // Reindexar names
                [...tbody.querySelectorAll('tr')].forEach((tr, i) => {
                    tr.querySelectorAll('input[name]').forEach(inp => {
                        inp.name = inp.name.replace(/Detalles\[\d+\]/, `Detalles[${i}]`);
                    });
                });

                recalcResumen();
            }
        });

        // Solo permitimos cambiar cantidad; precio/imp salen del producto
        tbody.addEventListener('input', e => {
            const input = e.target;
            if (!input.name || !input.name.includes('.Cantidad')) return;

            const tr = input.closest('tr');
            const cant = +input.value || 0;
            const precio = +tr.dataset.precio || 0;
            const impPercent = +tr.dataset.imp || 0;

            const bruto = cant * precio;
            const impMonto = bruto * (impPercent / 100);
            const total = bruto + impMonto;

            tr.dataset.totalLinea = total;
            tr.dataset.impMonto = impMonto;

            const totalSpan = tr.querySelector('.js-total-linea');
            if (totalSpan) totalSpan.textContent = fmt(total);

            const totalHidden = tr.querySelector('input[name*=".TotalLinea"]');
            if (totalHidden) totalHidden.value = total;

            recalcResumen();
        });

        document.getElementById('formPedido').addEventListener('submit', e => {
            if (tbody.querySelectorAll('tr').length === 0) {
                e.preventDefault();
                alert('Debes agregar al menos un producto al pedido.');
            }
        });
    </script>
}